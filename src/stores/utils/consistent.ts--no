import { derived } from 'svelte/store';

export default function asyncDerivedConsistent(stores, callback, initial_value, param) {
	// console.debug('ğŸš” asyncDerivedConsistent');
	let guard;
	return derived(
		stores,
		($stores, set) => {
			// console.debug('ğŸš” a');
			const inner = (guard = {});
			set(initial_value);
			Promise.resolve(callback($stores, param)).then((value) => {
				// console.debug('ğŸš” b');
				if (guard === inner) {
					set(value);
				}
			});
		},
		initial_value
	);
}
